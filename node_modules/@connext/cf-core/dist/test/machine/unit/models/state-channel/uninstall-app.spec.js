"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const constants_1 = require("ethers/constants");
const utils_1 = require("ethers/utils");
const constants_2 = require("../../../../../src/constants");
const machine_1 = require("../../../../../src/machine");
const models_1 = require("../../../../../src/models");
const utils_2 = require("../../../../unit/utils");
const random_signing_keys_1 = require("../../../integration/random-signing-keys");
const mocks_1 = require("../../../mocks");
describe("StateChannel::uninstallApp", () => {
    const networkContext = mocks_1.generateRandomNetworkContext();
    let sc1;
    let sc2;
    let testApp;
    beforeAll(() => {
        const multisigAddress = utils_1.getAddress(utils_1.hexlify(utils_1.randomBytes(20)));
        const xpubs = random_signing_keys_1.getRandomExtendedPubKeys(2);
        sc1 = models_1.StateChannel.setupChannel(networkContext.IdentityApp, networkContext.ProxyFactory, multisigAddress, xpubs);
        testApp = utils_2.createAppInstanceForTest(sc1);
        sc1 = sc1.installApp(testApp, {
            [constants_2.CONVENTION_FOR_ETH_TOKEN_ADDRESS]: {
                [machine_1.xkeyKthAddress(xpubs[0], 0)]: constants_1.Zero,
                [machine_1.xkeyKthAddress(xpubs[1], 0)]: constants_1.Zero
            }
        });
        sc2 = sc1.uninstallApp(testApp.identityHash, {
            [constants_2.CONVENTION_FOR_ETH_TOKEN_ADDRESS]: {
                [machine_1.xkeyKthAddress(xpubs[0], 0)]: constants_1.Zero,
                [machine_1.xkeyKthAddress(xpubs[1], 0)]: constants_1.Zero
            }
        });
    });
    it("should not alter any of the base properties", () => {
        expect(sc2.multisigAddress).toBe(sc1.multisigAddress);
        expect(sc2.userNeuteredExtendedKeys).toBe(sc1.userNeuteredExtendedKeys);
    });
    it("should not have changed the sequence number", () => {
        expect(sc2.numProposedApps).toBe(sc1.numProposedApps);
    });
    it("should have decreased the active apps number", () => {
        expect(sc2.numActiveApps).toBe(sc1.numActiveApps - 1);
    });
    it("should have deleted the app being uninstalled", () => {
        expect(sc2.isAppInstanceInstalled(testApp.identityHash)).toBe(false);
    });
    describe("the updated ETH Free Balance", () => {
        let fb;
        beforeAll(() => {
            fb = sc2.getFreeBalanceClass();
        });
        it("should have updated balances for Alice and Bob", () => {
            for (const amount of Object.values(fb.withTokenAddress(constants_2.CONVENTION_FOR_ETH_TOKEN_ADDRESS) || {})) {
                expect(amount).toEqual(constants_1.Zero);
            }
        });
    });
});
//# sourceMappingURL=uninstall-app.spec.js.map