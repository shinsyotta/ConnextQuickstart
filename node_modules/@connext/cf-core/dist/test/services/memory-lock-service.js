"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const lock_1 = require("./lock");
class MemoryLockService {
    constructor() {
        this.locks = new Map();
    }
    async acquireLock(lockName, callback, timeout) {
        const lock = this.getOrCreateLock(lockName);
        let retval = null;
        let rejectReason = null;
        let unlockKey = "";
        try {
            unlockKey = await lock.acquireLock(timeout);
            retval = await callback();
        }
        catch (e) {
            rejectReason = e;
        }
        finally {
            await lock.releaseLock(unlockKey);
        }
        if (rejectReason)
            throw rejectReason;
        return retval;
    }
    getOrCreateLock(lockName) {
        if (!this.locks.has(lockName)) {
            this.locks.set(lockName, new lock_1.Lock(lockName));
        }
        return this.locks.get(lockName);
    }
}
exports.MemoryLockService = MemoryLockService;
exports.default = MemoryLockService;
//# sourceMappingURL=memory-lock-service.js.map