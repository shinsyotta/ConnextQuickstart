"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const constants_1 = require("ethers/constants");
const utils_1 = require("ethers/utils");
const constants_2 = require("../../src/constants");
const types_1 = require("../../src/types");
const bignumber_jest_matcher_1 = require("../machine/integration/bignumber-jest-matcher");
const setup_1 = require("./setup");
const utils_2 = require("./utils");
expect.extend({ toBeLt: bignumber_jest_matcher_1.toBeLt });
jest.setTimeout(15000);
const { TicTacToeApp } = global["networkContext"];
describe("Concurrently uninstalling virtual and regular applications without issue", () => {
    let multisigAddressAB;
    let multisigAddressBC;
    let nodeA;
    let nodeB;
    let nodeC;
    beforeEach(async () => {
        const context = await setup_1.setup(global, true);
        nodeA = context["A"].node;
        nodeB = context["B"].node;
        nodeC = context["C"].node;
        multisigAddressAB = await utils_2.createChannel(nodeA, nodeB);
        multisigAddressBC = await utils_2.createChannel(nodeB, nodeC);
        await utils_2.collateralizeChannel(multisigAddressAB, nodeA, nodeB, utils_1.parseEther("2"));
        await utils_2.collateralizeChannel(multisigAddressBC, nodeB, nodeC, utils_1.parseEther("2"));
    });
    it("can handle a virtual and regular TTT app uninstall", async (done) => {
        let totalAppsUninstalled = 0;
        nodeB.on(types_1.NODE_EVENTS.PROPOSE_INSTALL, (msg) => {
            utils_2.makeInstallCall(nodeB, msg.data.appInstanceId);
        });
        const decodeNode = (pubId) => {
            switch (pubId) {
                case nodeA.publicIdentifier:
                    return "Node A";
                case nodeB.publicIdentifier:
                    return "Node B";
                case nodeC.publicIdentifier:
                    return "Node C";
                default:
                    return "unknown";
            }
        };
        const appId = await new Promise(resolve => {
            nodeA.on(types_1.NODE_EVENTS.INSTALL, (msg) => {
                resolve(msg.data.params.appInstanceId);
            });
            nodeA.rpcRouter.dispatch(utils_2.makeProposeCall(nodeB, TicTacToeApp, undefined, constants_1.One, constants_2.CONVENTION_FOR_ETH_TOKEN_ADDRESS, constants_1.One, constants_2.CONVENTION_FOR_ETH_TOKEN_ADDRESS));
        });
        const virtualId = await utils_2.installVirtualApp(nodeA, nodeB, nodeC, TicTacToeApp);
        nodeC.on(types_1.NODE_EVENTS.UNINSTALL_VIRTUAL, () => {
            totalAppsUninstalled += 1;
            if (totalAppsUninstalled === 2)
                done();
        });
        nodeA.on(types_1.NODE_EVENTS.UNINSTALL, () => {
            totalAppsUninstalled += 1;
            if (totalAppsUninstalled === 2)
                done();
        });
        nodeA.rpcRouter.dispatch(utils_2.constructUninstallVirtualRpc(virtualId, nodeB.publicIdentifier));
        nodeB.rpcRouter.dispatch(utils_2.constructUninstallRpc(appId));
    });
});
//# sourceMappingURL=uninstall-concurrent-mixed.spec.js.map