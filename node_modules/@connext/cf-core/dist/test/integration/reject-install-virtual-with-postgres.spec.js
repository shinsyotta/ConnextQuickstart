"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const types_1 = require("../../src/types");
const setup_1 = require("./setup");
const utils_1 = require("./utils");
const { TicTacToeApp } = global["networkContext"];
describe("Node method follows spec - rejectInstallVirtual", () => {
    let nodeA;
    let nodeB;
    let nodeC;
    beforeAll(async () => {
        const context = await setup_1.setupWithMemoryMessagingAndPostgresStore(global, true);
        nodeA = context["A"].node;
        nodeB = context["B"].node;
        nodeC = context["C"].node;
    });
    describe("Node A makes a proposal through an intermediary Node B to install a " +
        "Virtual AppInstance with Node C. Node C rejects proposal. Node A confirms rejection", () => {
        it.skip("sends proposal with non-null initial state", async (done) => {
            await utils_1.createChannel(nodeA, nodeB);
            await utils_1.createChannel(nodeB, nodeC);
            let proposalParams;
            nodeA.on(types_1.NODE_EVENTS.REJECT_INSTALL_VIRTUAL, async () => {
                expect((await utils_1.getProposedAppInstances(nodeA)).length).toEqual(0);
                done();
            });
            nodeC.on(types_1.NODE_EVENTS.PROPOSE_INSTALL, async (msg) => {
                const { appInstanceId } = msg.data;
                const [proposedAppInstanceA] = await utils_1.getProposedAppInstances(nodeA);
                const [proposedAppInstanceC] = await utils_1.getProposedAppInstances(nodeC);
                utils_1.confirmProposedAppInstance(proposalParams, proposedAppInstanceA);
                utils_1.confirmProposedAppInstance(proposalParams, proposedAppInstanceC);
                expect(proposedAppInstanceC.proposedByIdentifier).toEqual(nodeA.publicIdentifier);
                expect(proposedAppInstanceA.identityHash).toEqual(proposedAppInstanceC.identityHash);
                const rejectReq = utils_1.constructRejectInstallRpc(appInstanceId);
                await nodeC.rpcRouter.dispatch(rejectReq);
                expect((await utils_1.getProposedAppInstances(nodeC)).length).toEqual(0);
            });
            const result = await utils_1.makeVirtualProposeCall(nodeA, nodeC, TicTacToeApp);
            proposalParams = result.params;
        });
    });
});
//# sourceMappingURL=reject-install-virtual-with-postgres.spec.js.map