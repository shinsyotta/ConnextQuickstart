"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const deferred_1 = require("../deferred");
async function addToManyQueues(queues, task) {
    if (queues.length === 0)
        return await task();
    let promise;
    function runTaskWithMemoization() {
        if (!promise)
            promise = task();
        return promise;
    }
    const deferreds = [...Array(queues.length)].map(() => new deferred_1.Deferred());
    const waitForEveryQueueToFinish = Promise.all(deferreds.map(d => d.promise));
    await Promise.all(queues.map((q, i) => q.add(() => {
        deferreds[i].resolve();
        return waitForEveryQueueToFinish.then(runTaskWithMemoization);
    })));
    return await runTaskWithMemoization();
}
exports.addToManyQueues = addToManyQueues;
//# sourceMappingURL=queued-execution.js.map